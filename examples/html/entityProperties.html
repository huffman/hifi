<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" type="text/css" href="css/colpick.css">
        <script src="jquery-2.1.4.min.js"></script>
        <script src="colpick.js"></script>
        <script>
            const PI = 3.14159265358979;
            const DEGREES_TO_RADIANS = PI / 180.0;
            const RADIANS_TO_DEGREES = 180.0 / PI;

            const TYPE_COLOR = "Color";
            const TYPE_BOOL = "Bool";
            const TYPE_VEC3 = "Vec3";
            const TYPE_QUAT = "Quat";
            const TYPE_TEXT = "Text";
            const TYPE_TEXTAREA = "TextArea";
            const TYPE_URL = "Url";
            const TYPE_ENUM = "Enum";
            const TYPE_NUMBER = "Number";

            const PROPERTY_TYPE_OVERRIDES = {
                "color": TYPE_COLOR
            };

            const LAYOUT = [
                [
                    "Core",
                    ["Name", "name", TYPE_TEXT],
                    ["Locked", "locked", TYPE_BOOL],
                    ["Visible", "visible", TYPE_BOOL],
                    ["User Data", "userData", TYPE_TEXTAREA],
                ],
                [
                    "Physical Properties",
                    ["Position", "position", TYPE_VEC3],
                    ["Dimensions", "dimensions", TYPE_VEC3],
                    ["Registration", "registrationPoint", TYPE_VEC3],
                    ["Rotation", "rotation", TYPE_QUAT],
                    ["Linear Velocity", "velocity", TYPE_VEC3],
                    ["Angular Velocity", "angularVelocity", TYPE_VEC3],
                    ["Gravity", "gravity", TYPE_VEC3],
                    ["Acceleration", "acceleration", TYPE_VEC3],
                    ["Restitution", "restitution", TYPE_NUMBER],
                    ["Friction", "friction", TYPE_NUMBER],
                    ["Density", "density", TYPE_NUMBER],
                    ["Ignore for Collisions", "ignoreForCollisions", TYPE_BOOL],
                    ["Collisions Will Move", "collisionsWillMove", TYPE_BOOL],
                    ["Lifetime", "lifetime", TYPE_NUMBER],
                ],
                [
                    "Scripts",
                    ["Script URL", "script", TYPE_URL],
                    ["Script Timestamp", "scriptTimestamp", TYPE_NUMBER],
                    ["Color", "color", TYPE_COLOR],
                ],
                [
                    "PolyVox",
                    ["Voxel Volume Size", "", TYPE_VEC3],
                    ["Surface Extractor", "", TYPE_ENUM, ["marching cubes", "cubic", "edged cubic", "edged marching cubes"]],
                    ["X-Axis Texture URL", "", TYPE_URL],
                    ["Y-Axis Texture URL", "", TYPE_URL],
                    ["Z-Axis Texture URL", "", TYPE_URL],
                ],
                [
                    "Particle System",
                ]
            ];

            function PropertyElement(name, type) {
                this.name = name;
                this.type = type;
                this.elements = [];
            }
            PropertyElement.prototype.setValue = function(newValue) {
                print("setValue not implemented for ", this.name, this.type);
            };
            PropertyElement.prototype.valueChanged = function(newValue) {
            };
            PropertyElement.prototype.onValueChanged = function(newValue) {
            };
            PropertyElement.prototype.appendToElement = function($el) {
                for (var i = 0; i < this.elements.length; ++i) {
                    $el.append(this.elements[i]);
                }
            };
            PropertyElement.prototype.setVisible = function(visible) {
                var display = visible ? 'block' : 'none';
                for (var i = 0; i < this.elements.length; ++i) {
                    this.elements[i].css('display', display);
                }
            };
            PropertyElement.prototype.setEnabled = function(enabled) {
                var disabled = enabled ? '' : 'disabled';
                for (var i = 0; i < this.elements.length; ++i) {
                    this.elements[i].attr('disabled', disabled);
                }
            };

            function BoolPropertyElement(name) {
                PropertyElement.call(this, name, TYPE_BOOL);

                this.$checkbox = $('<input>').attr('type', 'checkbox');
                this.elements = [this.$checkbox];
            }
            BoolPropertyElement.prototype = Object.create(PropertyElement.prototype);
            BoolPropertyElement.prototype.setValue = function(newValue) {
                this.$checkbox.prop('checked', newValue === true);
            };

            function URLPropertyElement(name) {
                PropertyElement.call(this, name, TYPE_BOOL);

                this.$url = $('<input>').addClass('url');
                this.elements = [this.$url];
                this.$url.change(function() {
                    this.valueChanged(this.$url.text());
                });
            }
            URLPropertyElement.prototype = Object.create(PropertyElement.prototype);
            URLPropertyElement.prototype.setValue = function(newValue) {
                this.$url.text(newValue);
            };

            function EnumPropertyElement(name, args) {
                PropertyElement.call(this, name, TYPE_BOOL);

                console.log('enum', name, args);

                var options = args[0];
                this.$dropdown = $('<select>');
                for (var i = 0; i < options.length; ++i) {
                    //console.log(options[i]);
                    this.$dropdown.append($('<option>').val(options[i]).text(options[i]));
                }
                this.elements = [this.$dropdown];
            }
            EnumPropertyElement.prototype = Object.create(PropertyElement.prototype);
            EnumPropertyElement.prototype.setValue = function(newValue) {
            };

            function NumberPropertyElement(name) {
                PropertyElement.call(this, name, TYPE_NUMBER);

                this.$number = $('<input class="coord" type="number">');

                this.elements = [this.$number];
            }
            NumberPropertyElement.prototype = Object.create(PropertyElement.prototype);
            NumberPropertyElement.prototype.setValue = function(newValue) {
                this.$number.text(newValue.toFixed(2));
            };

            function Vec3PropertyElement(name) {
                PropertyElement.call(this, name, TYPE_BOOL);

                this.$inputX = $('<div class="input-area">X <br><input class="coord" type="number"></input></div>');
                this.$inputY = $('<div class="input-area">Y <br><input class="coord" type="number"></input></div>');
                this.$inputZ = $('<div class="input-area">Z <br><input class="coord" type="number"></input></div>');

                this.elements = [this.$inputX, this.$inputY, this.$inputZ];
            }
            Vec3PropertyElement.prototype = Object.create(PropertyElement.prototype);
            Vec3PropertyElement.prototype.setValue = function(newValue) {
                //console.log(this.name, newValue);
                this.$inputX.find("input").val(newValue.x.toFixed(2));
                this.$inputY.find("input").val(newValue.y.toFixed(2));
                this.$inputZ.find("input").val(newValue.z.toFixed(2));
            };
            // Quat is an alias for Vec3 - we will be receiving euler angles from the client.
            QuatPropertyElement = Vec3PropertyElement;

            function TextPropertyElement(name) {
                PropertyElement.call(this, name, TYPE_TEXT);

                this.$text = $('<input type="text">');
                this.elements = [this.$text];
            }
            TextPropertyElement.prototype = Object.create(PropertyElement.prototype);
            TextPropertyElement.prototype.setValue = function(newValue) {
                this.$text.val(newValue);
            };

            function TextAreaPropertyElement(name) {
                PropertyElement.call(this, name, TYPE_TEXT);

                this.$text = $('<textarea>');
                this.elements = [this.$text];
            }
            TextAreaPropertyElement.prototype = Object.create(PropertyElement.prototype);
            TextAreaPropertyElement.prototype.setValue = function(newValue) {
                this.$text.val(newValue);
            };

            function ColorPropertyElement(name) {
                PropertyElement.call(this, name, TYPE_COLOR);

                this.$colorPicker = $('<div>').addClass('color-picker');
                this.$rInput = $('<div class="input-area">R <input class="coord" type="number"></input></div>');
                this.$gInput = $('<div class="input-area">G <input class="coord" type="number"></input></div>');
                this.$bInput = $('<div class="input-area">B <input class="coord" type="number"></input></div>');

                this.$colorPicker.colpick({
                    colorScheme:'dark',
                    layout:'hex',
                    color:'000000',
                    onSubmit: function(hsb, hex, rgb, el) {
                        $(el).css('background-color', '#'+hex);
                        $(el).colpickHide();
                        //emitColorPropertyUpdate('color', rgb.r, rgb.g, rgb.b, 'skybox');
                    }
                });

                this.elements = [this.$colorPicker, this.$rInput, this.$gInput, this.$bInput];
            }
            ColorPropertyElement.prototype = Object.create(PropertyElement.prototype);
            ColorPropertyElement.prototype.setValue = function(newValue) {
                this.$rInput.find("input").val(newValue.red);
                this.$gInput.find("input").val(newValue.green);
                this.$bInput.find("input").val(newValue.blue);
                this.$colorPicker.css('background-color', 'rgb(' + newValue.red + ',' + newValue.green + ',' + newValue.blue + ')');
            };

            var propertyToElementMap = {
            };

            function detectPropertyType(name, value) {
                // Special case certain property names
                if (name in PROPERTY_TYPE_OVERRIDES) {
                    return PROPERTY_TYPE_OVERRIDES[name];
                }

                // Detect type based on value
                if ("red" in value) {
                    return TYPE_COLOR;
                } else if ("w" in value) {
                    return TYPE_QUAT;
                } else if ("x" in value) {
                    return TYPE_VEC3;
                }
            }

            var typeToClassMap = {};
            typeToClassMap[TYPE_COLOR] = ColorPropertyElement;
            typeToClassMap[TYPE_BOOL] = BoolPropertyElement;
            typeToClassMap[TYPE_TEXT] = TextPropertyElement;
            typeToClassMap[TYPE_TEXTAREA] = TextAreaPropertyElement;
            typeToClassMap[TYPE_VEC3] = Vec3PropertyElement;
            typeToClassMap[TYPE_QUAT] = QuatPropertyElement;
            typeToClassMap[TYPE_URL] = URLPropertyElement;
            typeToClassMap[TYPE_ENUM] = EnumPropertyElement;
            typeToClassMap[TYPE_NUMBER] = NumberPropertyElement;

            var propertyElements = [];
            function createPropertyElement(name, type, args) {
                var el;
                //console.log(name, type, args);
                var ctor = typeToClassMap[type];
                if (ctor) {
                    //console.log(name, type, args, ctor);
                    el = new ctor(name, args);
                    propertyElements.push(el);
                } else {
                    //console.log('fail', type)
                }
                return el;
            }

            function emitUpdate(name, group, value) {
                var properties = {};

                if (group) {
                    properties[group] = {};
                    properties[group][name] = value;
                } else {
                    properties[name] = value;
                }

                EventBridge.emitWebEvent(
                    JSON.stringify({
                        type: "update",
                        properties: properties
                    })
                );
            }

            function updateProperties(properties) {
                var $id = $('#property-id');
                var $type = $('#property-type');
                $id.text(properties.id);
                $type.text(properties.type);

                var len = propertyElements.length;
                //console.log('len ' + len);
                for (var i = 0; i < len; ++i) {
                    var el = propertyElements[i];
                    var value = properties[el.name];
                    if (value) {
                        el.setVisible(true);
                        el.setValue(value);
                    } else {
                        el.setVisible(false);
                    }
                }
            }

            function loaded() {
                var $id = $('#property-id');
                var $type = $('#property-type');

                // Setup properties
                var $propertiesList = $('#properties-list');
                for (var i = 0; i < LAYOUT.length; ++i) {
                    var section = LAYOUT[i];
                    var sectionName = section[0];

                    // Create section element
                    var $section = $('<div class="section-header">').append($('<label>').text(sectionName));
                    $propertiesList.append($section);

                    for (var j = 1; j < section.length; ++j) {
                        var propertyInfo = section[j];
                        var propertyLabel = propertyInfo[0];
                        var propertyName = propertyInfo[1];
                        var propertyType = propertyInfo[2];
                        var propertyArgs = propertyInfo.splice(3);

                        // Create property element
                        var propertyElement = createPropertyElement(propertyName, propertyType, propertyArgs);

                        var $container = $('<div class="property">');
                        $container.append($('<div class="label">').text(propertyLabel));

                        // Add element to body
                        if (propertyElement) {
                            propertyElement.appendToElement($container);
                        }

                        $section.append($container);
                        $propertiesList.append($section);
                    }
                }

                var p = JSON.parse('{"id":"{2c40f124-58d7-44c1-913a-b025c3f75e24}","type":"Box","created":"2015-09-25T16:46:22Z","age":1647.8382568359375,"ageAsText":"0 hours 27 minutes 27 seconds","position":{"x":0.6832643747329712,"y":0.7502224445343018,"z":-2.570009231567383},"dimensions":{"x":0.20000000298023224,"y":0.20000000298023224,"z":0.20000000298023224},"naturalDimensions":{"x":1,"y":1,"z":1},"naturalPosition":{"x":0,"y":0,"z":0},"rotation":{"x":0,"y":0,"z":0},"velocity":{"x":0,"y":0,"z":0},"gravity":{"x":0,"y":0,"z":0},"acceleration":{"x":0,"y":0,"z":0},"damping":0.39346998929977417,"restitution":0.5,"friction":0.5,"density":1000,"lifetime":-1,"script":"","scriptTimestamp":0,"registrationPoint":{"x":0.5,"y":0.5,"z":0.5},"angularVelocity":{"x":0,"y":0,"z":0},"angularDamping":0.39346998929977417,"visible":1,"ignoreForCollisions":0,"collisionsWillMove":0,"href":"","description":"","actionData":"","locked":0,"userData":"","marketplaceID":"","name":"","collisionSoundURL":"","color":{"red":255,"green":0,"blue":0},"sittingPoints":{"length":0},"boundingBox":{"brn":{"x":0.5832643508911133,"y":0.6502224206924438,"z":-2.670009136199951},"tfl":{"x":0.7832643985748291,"y":0.8502224683761597,"z":-2.4700093269348145},"center":{"x":0.6832643747329712,"y":0.7502224445343018,"z":-2.570009231567383},"dimensions":{"x":0.20000004768371582,"y":0.20000004768371582,"z":0.19999980926513672}},"originalTextures":""}');
                updateProperties({
                    type: "blah",
                    name: "Ryan",
                });
                updateProperties(p);

                if (window.EventBridge !== undefined) {
                    EventBridge.scriptEventReceived.connect(function(data) {
                        data = JSON.parse(data);
                        if (data.type == "update") {
                            if (data.selections.length == 0) {
                                $type.text = "<i>No Selection</i>";
                                $id.text = "";
                                $('#properties-list input').attr('disabled', 'disabled');
                                disableChildren(document.getElementById("properties-list"), 'input');
                            } else if (data.selections.length > 1) {
                                var selections = data.selections;

                                var ids = [];
                                var types = {};

                                for (var i = 0; i < selections.length; i++) {
                                    ids.push(selections[i].id);
                                    var type = selections[i].properties.type;
                                    if (types[type] === undefined) {
                                        types[type] = 0;
                                    }
                                    types[type]++;
                                }
                                //elID.innerHTML = ids.join("<br>");
                                $id.text(ids.join('<br>'));

                                var typeStrs = [];
                                for (type in types) {
                                    typeStrs.push(type + " (" + types[type] + ")");
                                }
                                $type.text(typeStrs.join(', '));

                                $('#properties-list input').attr('disabled', 'disabled');
                            } else {
                                var activeElement = document.activeElement;

                                try {
                                    var selected = (activeElement
                                        && activeElement.selectionStart == 0
                                        && activeElement.selectionEnd == activeElement.value.length);
                                } catch (e) {
                                    var  selected = false;
                                }

                                var properties = data.selections[0].console;
                                //properties.log(JSON.stringify(properties));

                                updateProperties(properties);
                                return;

                                elLocked.checked = properties.locked;

                                if (properties.locked) {
                                    disableChildren(document.getElementById("properties-list"), 'input');
                                    elLocked.removeAttribute('disabled');
                                } else {
                                    enableChildren(document.getElementById("properties-list"), 'input');
                                }

                                if (selected) {
                                    activeElement.focus();
                                    activeElement.select();
                                }
                            }
                        }
                    });
                }

                if (false) {
                    elMoveSelectionToGrid.addEventListener("click", function() {
                        EventBridge.emitWebEvent(JSON.stringify({
                            type: "action",
                            action: "moveSelectionToGrid",
                        }));
                    });
                    elMoveAllToGrid.addEventListener("click", function() {
                        EventBridge.emitWebEvent(JSON.stringify({
                            type: "action",
                            action: "moveAllToGrid",
                        }));
                    });
                    elResetToNaturalDimensions.addEventListener("click", function() {
                        EventBridge.emitWebEvent(JSON.stringify({
                            type: "action",
                            action: "resetToNaturalDimensions",
                        }));
                    });
                    elRescaleDimensionsButton.addEventListener("click", function() {
                        EventBridge.emitWebEvent(JSON.stringify({
                            type: "action",
                            action: "rescaleDimensions",
                            percentage: parseInt(elRescaleDimensionsPct.value),
                        }));
                    });
                    elReloadScriptButton.addEventListener("click", function() {
                        EventBridge.emitWebEvent(JSON.stringify({
                            type: "action",
                            action: "reloadScript"
                        }));
                    });
                    elCenterAtmosphereToZone.addEventListener("click", function() {
                        EventBridge.emitWebEvent(JSON.stringify({
                            type: "action",
                            action: "centerAtmosphereToZone",
                        }));
                    });
                }

                window.onblur = function() {
                    // Fake a change event
                    var ev = document.createEvent("HTMLEvents");
                    ev.initEvent("change", true, true);
                    document.activeElement.dispatchEvent(ev);
                }

                // For input and textarea elements, select all of the text on focus
                // WebKit-based browsers, such as is used with QWebView, have a quirk
                // where the mouseup event comes after the focus event, causing the
                // text to be deselected immediately after selecting all of the text.
                // To make this work we block the first mouseup event after the elements
                // received focus.  If we block all mouseup events the user will not
                // be able to click within the selected text.
                // We also check to see if the value has changed to make sure we aren't
                // blocking a mouse-up event when clicking on an input spinner.
                var els = document.querySelectorAll("input, textarea");
                for (var i = 0; i < els.length; i++) {
                    var clicked = false;
                    var originalText;
                    els[i].onfocus = function() {
                        originalText = this.value;
                        this.select();
                        clicked = false;
                    };
                    els[i].onmouseup = function(e) {
                        if (!clicked && originalText == this.value) {
                            e.preventDefault();
                        }
                        clicked = true;
                    };
                }
            }

        </script>
    </head>

    <body class="properties" onload='loaded();'>
        <div id="properties-list">
            <div id="type" class="property">
                <div class="label">
                    <label>Type: </label><span id="property-type"></span>
                </div>
            </div>
            <div id="id" class="property">
                <span class="label" style="float: left; margin-right: 6px">
                    <label>ID: </label>
                </span>
                <div class="value">
                    <span id="property-id" class="selectable"></span>
                </div>
            </div>
        </div>
    </body>
</html>
